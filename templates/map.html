{%extends "nav.html"%}
{% block head %}
    <title>Singapore Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>


    <style>
        bhtml, body {
            
            height: 100vh; /* Sets the body height to fill the viewport */
            margin: 0; /* Removes default margin */
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        .sidebar {
            width: 20%; /* Adjust width as needed */
            background-color: #FFAA33;
            padding-top: 30px; /* Padding inside the sidebar */
            overflow-y: auto; /* Enables vertical scroll if content overflows */
            padding-left: 35px;
            padding-right: 35px;
        }
        #map {
            flex-grow: 1; /* Takes up remaining space */
            width: 80%; /* Adjust based on sidebar width */
        }
        .filter-section {
            text-align: center; 
            background: #d9d9d9;
            margin-top: -20px;
            height: 45px;
            font-color: white;
            

        }
        .filter-section form {
            width: 100%;

        }
        .filter-section select {
        width: 25%; 
        height: 45px;
        margin-bottom: 20px;
        box-sizing: border-box;
        background-color: #505050; 
        border-color:   white ;
        color:  white;
        margin-left: -5px;
        
        }
        .filter-section select:hover {
            background-color: #cee3ff;
          }
        .sidebar input[type="range"] {
        width: 100%;
        margin: 10px 0;
        .filterForm {
            dislay: flex;
        }
    }
    .sidebar {
        margin-left: -15px;
        background-color: #505050;
        padding-right: 20px;
        width: 20%;
        height:100%;
    }
    .filter-section select option:selected {
        font-color: white; 
        font-weight: bold; /* Bold font weight */
    }
    .aligns {
        text-align: center;
        color: white;
    }
    .slider {
        background-color: white;
        margin-right: 25px;
        border: none;
    }

    
    .noUi-connect {  
    background-color:#006969;
    border: none;
    }

    .noUi-handle {  /* Styling for the slider handles */

    border-radius: 50% !important; /* Make the handles fully rounded */
    width: 24px !important; /* Adjust the width as needed */
    height: 24px !important; /* Adjust the height as needed */
    top: -4px !important; /* Adjust top position to align handle center with slider line */
    background-color: :#505050 !important; /* Optional: Change background color */
    border: 1px solid #FFF !important; /* Optional: Change border */
    box-shadow: none !important; /* Optional: Remove or adjust the shadow */
    }

    .noUi-tooltip {
        background-color: white !important; /* Change tooltip background color */
        color: #505050 !important; /* Change tooltip text color */
        border-radius: 8px !important; /* Make the tooltip edges more rounded */
        padding: 3px 6px !important; /* Adjust padding inside the tooltip */
        font-size: 14px !important; /* Adjust tooltip font size */
        font-family: Arial, sans-serif !important; /* Change tooltip font family */
        box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important; /* Optional: Add a subtle shadow to the tooltip */
        font-style: bold;
    }
    

    .x {
        font-size: 12px;
        color: #ffeacc;
    }
    
    .y {
        color: #222222;
        font-family: Arial, sans-serif;
        display: inline-block; 
        vertical-align: middle; 
        margin-left: 8px;

    }
    .big {
        font-size: 18px;
        font-family: 'Source Sans Pro', sans-serif;
        margin-left: -20px;
        color: white;
    }
    .gg-home-alt {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs,1));
        width: 18px;
        height: 14px;
        border: 2px solid;
        border-top: 0;
        border-radius: 2px;
        border-bottom-left-radius: 3px;
        border-bottom-right-radius: 3px;
        margin-bottom: -2px
    }
    .gg-home-alt::after,
    .gg-home-alt::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute
    }
    .gg-home-alt::before {
        border-top: 2px solid;
        border-left: 2px solid;
        border-top-left-radius: 4px;
        transform: rotate(45deg);
        top: -5px;
        border-radius: 3px;
        width: 14px;
        height: 14px;
        left: 0
    }
    .gg-home-alt::after {
        width: 6px;
        height: 10px;
        background: currentColor;
        border-top-left-radius: 100px;
        border-top-right-radius: 100px;
        left: 4px;
        bottom: -2px
    }
    .bn62 {
        color: white;
        background-color: #006969;
        border-radius: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 2em;
        width: 8em;
        font-size: medium;
        font-weight: 500;
        margin-left: 20%;
      }
    #infoDiv {
        background-color:  #006969;
        height: 70%;
        margin-left: -32px;
        margin-right: -20px
    }
    #showdiv {
        background-color:  #006969;
        height: 70%;
        margin-left: -32px;
        margin-right: -20px
    }
    #mg {
        margin: 10px;
        padding-top: 10%;
    }
    #tt {
        margin: 5px;
        text-align: center;
        padding-top: 80%;
        font-family: Arial, sans-serif;
    }
    .info {
        color: white;
        font-size: 15px;
    }
    #img {
        width: 25px;
        height:25px;
        margin-bottom: 7px
    }

    </style>
{% endblock %}
{% block content %}
<div class="filter-section">

    <form id="filterForm" action="/map" method="get">
        <select id="years" name="years">
            {% for year in years %}
                <option class = "aligns" value="{{ year }}" {% if year|string() == selected_year %}selected{% endif %}>
                    {{ year }}
                </option>
            {% endfor %}
        </select>
        
        <select id="town" name="town">
            {% if selected_town == '' or selected_town == None%}
            <option class = "aligns" value="Select Town" disabled selected>Select Town</option>
            {% else %}
            <option class = "aligns" value="" disabled selected>{{selected_town}}</option>
            {%endif%}

            {% for town in towns %}
            {% if town == '' %}
                <option value="" class = "aligns">Select Town</option>
            {% else %}
            <option class = "aligns" value="{{ town }}" {% if town|string() == selected_town %}selected{% endif %}>
                {{ town }}
            </option>
            {% endif %}
        {% endfor %}
        </select>

        <select id="storeyRange" name="storeyRange" >
            {% if storey_range == '' or storey_range == None%}
            <option class = "aligns" value="Select Storey Range" disabled selected>Select Storey Range</option>
            {% else %}
            <option class = "aligns" value="" disabled selected>{{storey_range}}</option>
            {%endif%}
            {% for range in storey_ranges %}
            {% if range == '' %}
                <option value=""> Select Storey Range </option>
            {% else %}
                <option value="{{ range }}">{{ range }}</option>
            {%endif%}
            {% endfor %}
        </select>

        <select id="flatModel" name="flatModel" >
            {% if flat_model == '' or flat_model == None%}
            <option class = "aligns" value="Select Flat Model" disabled selected>Select Flat Model</option>
            {% else %}
            <option class = "aligns" value="" disabled selected>{{flat_model}}</option>
            {%endif%}
            {% for model in flat_models %}
            {% if model == '' %}
            <option value=""> Select Flat Model </option>
            {% else %}
            <option value="{{ model }}">{{ model }}</option>
            {%endif%}
            {% endfor %}
        </select>
    </form>
</div>

<div class="container">
    <div class="sidebar">
        <!-- Sidebar content here -->
        <p class = "big"> Resale Price Range: </p>
        <br>
        <div class = "slider" id="slider-price-range"></div>
        <br/>
        <button id="applyFilters" class="bn62" >Apply Filters</button>
        <br>
        
        <div id="infoDiv">
            <h4 id = 'tt'> Click a marker to show info here </h4>
        </div>
        <div id ="showdiv" style="display: none;">
            <div id = "mg">
            <img id="img" src="{{ url_for('static', filename='images/image.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class="y" >Address:</h5>
            <p class= "info" id = "add" class = "x"> </p>
            <img id="img" src="{{ url_for('static', filename='images/image1.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class = "y"> Price: </h5>
            <p class= "info" id = "price" class = "x"> </p>
            <img id="img" src="{{ url_for('static', filename='images/image2.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class = "y"> Closest Mrt: </h5>
            <p class= "info" id = "mrt" class = "x"> </p>
            <img id="img" src="{{ url_for('static', filename='images/image3.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class = "y"> Closest School: </h5>
            <p class= "info" id = "sch" class = "x"> </p>
            <img id="img" src="{{ url_for('static', filename='images/image4.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class = "y"> Closest Hospital: </h5>
            <p class= "info" id = "hosp" class = "x"> </p>
            <img id="img" src="{{ url_for('static', filename='images/mall.png') }}" style="display: inline-block; vertical-align: middle;">
            <h5 class = "y"> Closest Mall: </h5>
            <p class= "info" id = "mall" class = "x"> </p>

            </div>
        </div>
    </div>
    <div id="map"></div>
</div>
    


    <script >
        
        // Initialize the map
        var map = L.map('map').setView([1.3521, 103.8198], 12); // Center on Singapore with a zoom level of 12

        // Define the tile layer
        L.tileLayer('https://www.onemap.gov.sg/maps/tiles/Default/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.onemap.sg/home/">OneMap Singapore</a> contributors',
            maxZoom: 18,
        }).addTo(map);
        var fileData = {{ fileData | tojson | safe }};
    
        
        // Check if fileData is an array, if not convert it into one
        if (!Array.isArray(fileData)) {
            fileData = [fileData]; // Ensure fileData is an array
        }
        console.log(fileData)

        // Loop through the data and add markers
        fileData.forEach(function(item) {
            var lat = parseFloat(item.latitude);
            var lng = parseFloat(item.longitude);
            // Validate coordinates before adding the marker
            if (!isNaN(lat) && !isNaN(lng)) {
                var markerHtmlStyles = `
                    background-color:#006969;
                    width: 1.8rem;
                    height: 1.8rem;
                    display: block;
                    left: -1.5rem;
                    top: -1.5rem;
                    position: relative;
                    border-radius: 2rem 2rem 0;
                    transform: rotate(45deg);
                    border: 1px solid white`;
    
                var innerCircleStyles = `
                    width: 0.9rem;
                    height: 0.9rem;
                    border-radius: 50%;
                    background-color:white;
                    position: absolute;
                    top: 17%;
                    left: 13%;
                    padding-
                    transform: rotate(-45deg);`;
    
            var customMarkerIcon = L.divIcon({
                className: "my-custom-pin",
                iconAnchor: [0, 24],
                labelAnchor: [-6, 0],
                popupAnchor: [0, -36],
                html: `<div style="${markerHtmlStyles}"><div style="${innerCircleStyles}"></div></div>`
            });

            
            var marker = L.marker([lat, lng], { icon: customMarkerIcon }).addTo(map);

            // Here we define the content that will appear both in the popup and in the div
            var content = 'Address: ' + item.address + '<br>Resale Price: ' + item.resale_price;
            var address = item.address
            var price =  item.resale_price
            var mrt = item['Closest Station']
            var mrt_distance = item['Closest Station distance']
            var sch = item['Closest School']
            var sch_distance = item['Closest School distance']
            var hosp = item['Closest Healthcare']
            var hosp_distance = item['Closest Healthcare distance']
            var mall = item['Closest Mall']
            var mall_distance = item['Closest Mall distance']
            var divToHide = document.getElementById('infoDiv');
            var divToShow = document.getElementById('showdiv');
            // Bind the popup with the content
            marker.bindPopup(content);
            
            // Add a click event listener to the marker
            marker.on('click', function(e) {
                
                
                    divToHide.style.display = 'none'; // Hide it
                    divToShow.style.display = 'block'; // Show the second div
                    document.getElementById('add').innerHTML = address;
                    document.getElementById('price').innerHTML = '$'+ price;
                    document.getElementById('mrt').innerHTML = mrt + '</br> ' + parseFloat(mrt_distance.toFixed(3)) + "Km away";
                    document.getElementById('sch').innerHTML = sch + '</br>' + parseFloat(sch_distance.toFixed(3)) + "Km away";
                    document.getElementById('hosp').innerHTML = hosp + '</br>' + parseFloat(hosp_distance.toFixed(3)) + "Km away";
                    document.getElementById('mall').innerHTML = mall + '</br>' + parseFloat(mall_distance.toFixed(3)) + "Km away";
                
            });
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        const updateQueryStringParameter = (uri, key, value) => {
            const re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
            const separator = uri.indexOf('?') !== -1 ? "&" : "?";
            if (uri.match(re)) {
                return uri.replace(re, '$1' + key + "=" + value + '$2');
            } else {
                return uri + separator + key + "=" + value;
            }
        };
    
        document.querySelectorAll('#filterForm select').forEach(selectElement => {
            selectElement.addEventListener('change', function() {
                let currentUrl = window.location.href;
                let newUrl = updateQueryStringParameter(currentUrl, this.name, this.value);
                window.location.href = newUrl; // Navigate to the new URL
            });
        });
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Function to update URL query parameters
        const updateQueryStringParameter = (uri, key, value) => {
            const re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
            const separator = uri.indexOf('?') !== -1 ? "&" : "?";
            if (uri.match(re)) {
                return uri.replace(re, '$1' + key + "=" + value + '$2');
            } else {
                return uri + separator + key + "=" + value;
            }
        };
    
        // Function to get a query variable's value
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null; // Default to null if not found
        }
    
        // Initialize slider with values from URL or defaults
        var initialMinPrice = parseFloat(getQueryVariable('min_price')) || 160000; // Default min value
        var initialMaxPrice = parseFloat(getQueryVariable('max_price')) || 1185000; // Default max value
    
        var slider = document.getElementById('slider-price-range');
    
        noUiSlider.create(slider, {
            start: [initialMinPrice, initialMaxPrice],
            connect: true,
            range: {
                'min': 160000,
                'max': 1185000
            },
            step: 1000,
            tooltips: true,
            format: {
                to: function(value) {
                    return value.toFixed(0);
                },
                from: function(value) {
                    return Number(value);
                }
            }
        });
    
        // Update global variables on slider change
        slider.noUiSlider.on('change', function(values, handle) {
            let minValue = values[0];
            let maxValue = values[1];
            let currentUrl = window.location.href;
            let newUrl = updateQueryStringParameter(currentUrl, 'min_price', minValue);
            newUrl = updateQueryStringParameter(newUrl, 'max_price', maxValue);
            // Commented out to prevent immediate navigation
            // window.location.href = newUrl;
        });
    
        // Apply Filters button
        document.getElementById('applyFilters').addEventListener('click', function() {
            let minValue = slider.noUiSlider.get()[0];
            let maxValue = slider.noUiSlider.get()[1];
            let currentUrl = window.location.href;
            let newUrl = updateQueryStringParameter(currentUrl, 'min_price', minValue);
            newUrl = updateQueryStringParameter(newUrl, 'max_price', maxValue);
            window.location.href = newUrl; // Apply the filters
        });
    });

    
    
    </script>
    
    <!-- Attribution for OneMap -->
    <div style="position: absolute; bottom: 0; right: 0; background: white; padding: 5px;">
        <img src="https://www.onemap.gov.sg/web-assets/images/logo/om_logo.png" style="height:20px;width:20px;"/>&nbsp;
        <a href="https://www.onemap.gov.sg/" target="_blank" rel="noopener noreferrer">OneMap</a>&nbsp;&copy;&nbsp;contributors&nbsp;&#124;&nbsp;
        <a href="https://www.sla.gov.sg/" target="_blank" rel="noopener noreferrer">Singapore Land Authority</a>
    </div>
    {% endblock %}
    {% set active_tab = 'map' %}
